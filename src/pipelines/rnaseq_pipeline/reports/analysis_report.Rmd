---
title: "RNA-seq Differential Expression Analysis Report"
author: "Generated by RNA-seq Pipeline"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_depth: 3
    toc_float: true
    number_sections: true
    theme: flatly
    highlight: tango
    code_folding: hide
params:
  config: NULL
  qc_metrics: NULL
  filtering_stats: NULL
  annotation_stats: NULL
  pca_result: NULL
  sample_correlation: NULL
  outlier_detection: NULL
  de_results: NULL
  de_summary: NULL
  pathway_results: NULL
  commentary_tbl: NULL
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  message = FALSE,
  warning = FALSE,
  fig.width = 10,
  fig.height = 6
)

library(tidyverse)
library(DT)
library(pheatmap)
library(ggrepel)
library(RColorBrewer)

# Source commentary functions if available
tryCatch({
  source(here::here("R", "09_commentary.R"))
  commentary_available <- TRUE
}, error = function(e) {
  commentary_available <<- FALSE
})

# Helper function to get commentary for a figure
get_commentary <- function(figure_id) {
  if (is.null(params$commentary_tbl)) return(NULL)
  tryCatch({
    get_figure_commentary(params$commentary_tbl, figure_id)
  }, error = function(e) {
    NULL
  })
}

# Helper to render commentary block
render_commentary <- function(figure_id, plot_type = NULL) {
  commentary <- get_commentary(figure_id)

  if (!is.null(commentary)) {
    html_output <- format_commentary_html(commentary)

    # Add static explanation if available
    if (!is.null(plot_type)) {
      static <- get_static_explanation(plot_type)
      html_output <- paste0(html_output, static)
    }

    cat(html_output)
  } else {
    cat("<div class='commentary-block commentary-unavailable'><p><em>Commentary unavailable for this figure.</em></p></div>")
  }
}
```

<style>
/* Commentary block styling */
.commentary-block {
  background-color: #f8f9fa;
  border-left: 4px solid #007bff;
  padding: 15px 20px;
  margin: 15px 0;
  border-radius: 0 4px 4px 0;
}

.commentary-block.commentary-unavailable {
  border-left-color: #6c757d;
  background-color: #f1f1f1;
}

.commentary-section {
  margin-bottom: 12px;
}

.commentary-section h5 {
  color: #495057;
  font-size: 0.95em;
  margin-bottom: 8px;
  font-weight: 600;
}

.commentary-section ul {
  margin: 0;
  padding-left: 20px;
}

.commentary-section li {
  margin-bottom: 4px;
  font-size: 0.9em;
}

.commentary-section p {
  margin: 0;
  font-size: 0.9em;
}

.commentary-footer {
  margin-top: 10px;
  padding-top: 8px;
  border-top: 1px solid #dee2e6;
  color: #6c757d;
}

.static-explanation {
  margin-top: 10px;
}

.static-explanation details {
  background-color: #e9ecef;
  padding: 10px 15px;
  border-radius: 4px;
}

.static-explanation summary {
  cursor: pointer;
  color: #495057;
}

.static-explanation p {
  margin: 10px 0 0 0;
  font-size: 0.85em;
  color: #6c757d;
}
</style>

# Overview

This report summarizes the results of the bulk RNA-seq differential expression and pathway analysis pipeline.

## Analysis Parameters

```{r params-table}
if (!is.null(params$config)) {
  param_df <- data.frame(
    Parameter = c("Organism", "Design Formula", "Alpha", "LFC Threshold", "Commentary Enabled"),
    Value = c(
      params$config$organism,
      params$config$design_formula,
      params$config$alpha,
      params$config$lfc_threshold,
      ifelse(isTRUE(params$config$commentary_enabled), "Yes", "No")
    )
  )
  knitr::kable(param_df, caption = "Analysis Parameters")
}
```

------------------------------------------------------------------------

# Quality Control

## Sample Metrics

```{r qc-metrics}
if (!is.null(params$qc_metrics)) {
  DT::datatable(
    params$qc_metrics,
    caption = "Sample QC Metrics",
    options = list(pageLength = 10, scrollX = TRUE),
    rownames = FALSE
  ) %>%
    DT::formatRound(columns = c("detection_rate", "cv"), digits = 3)
}
```

## Library Sizes

```{r library-sizes, fig.cap="Total sequencing depth per sample"}
if (!is.null(params$qc_metrics)) {
  ggplot(params$qc_metrics, aes(x = reorder(sample, -total_counts), y = total_counts / 1e6)) +
    geom_bar(stat = "identity", fill = "steelblue") +
    labs(x = "Sample", y = "Total Counts (millions)") +
    theme_minimal() +
    theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 8))
}
```

```{r library-sizes-commentary, results='asis'}
render_commentary("library_sizes", "library_sizes")
```

## Detected Genes

```{r detected-genes, fig.cap="Number of genes detected per sample"}
if (!is.null(params$qc_metrics)) {
  ggplot(params$qc_metrics, aes(x = reorder(sample, -detected_genes), y = detected_genes)) +
    geom_bar(stat = "identity", fill = "darkorange") +
    labs(x = "Sample", y = "Detected Genes") +
    theme_minimal() +
    theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 8))
}
```

```{r detected-genes-commentary, results='asis'}
render_commentary("detected_genes", "detected_genes")
```

## Sample Correlation

```{r sample-correlation, fig.width=10, fig.height=10, fig.cap="Sample-to-sample Pearson correlation heatmap"}
if (!is.null(params$sample_correlation)) {
  pheatmap(
    params$sample_correlation,
    color = colorRampPalette(c("blue", "white", "red"))(100),
    border_color = NA,
    fontsize = 8,
    main = "Sample Correlation Matrix"
  )
}
```

```{r sample-correlation-commentary, results='asis'}
render_commentary("sample_correlation", "sample_correlation")
```

## Principal Component Analysis

```{r pca-plot, fig.cap="PCA plot of samples based on top variable genes"}
if (!is.null(params$pca_result)) {
  pca_data <- params$pca_result$pca_data
  var_exp <- params$pca_result$var_explained

  # Check for group column
  group_col <- params$config$group_col

  if (!is.null(group_col) && group_col %in% colnames(pca_data)) {
    ggplot(pca_data, aes(x = PC1, y = PC2, color = .data[[group_col]])) +
      geom_point(size = 3) +
      geom_text_repel(aes(label = sample), size = 3, max.overlaps = 15) +
      labs(
        x = paste0("PC1 (", round(var_exp[1], 1), "%)"),
        y = paste0("PC2 (", round(var_exp[2], 1), "%)")
      ) +
      theme_minimal() +
      theme(legend.position = "right")
  } else {
    ggplot(pca_data, aes(x = PC1, y = PC2)) +
      geom_point(size = 3, color = "steelblue") +
      geom_text_repel(aes(label = sample), size = 3, max.overlaps = 15) +
      labs(
        x = paste0("PC1 (", round(var_exp[1], 1), "%)"),
        y = paste0("PC2 (", round(var_exp[2], 1), "%)")
      ) +
      theme_minimal()
  }
}
```

```{r pca-plot-commentary, results='asis'}
render_commentary("pca_plot", "pca_plot")
```

## PCA Variance Explained

```{r pca-scree, fig.cap="Variance explained by each principal component"}
if (!is.null(params$pca_result)) {
  var_exp <- params$pca_result$var_explained
  var_df <- data.frame(
    PC = paste0("PC", 1:min(10, length(var_exp))),
    variance = var_exp[1:min(10, length(var_exp))]
  )
  var_df$PC <- factor(var_df$PC, levels = var_df$PC)

  ggplot(var_df, aes(x = PC, y = variance)) +
    geom_bar(stat = "identity", fill = "steelblue") +
    geom_line(aes(group = 1), color = "red") +
    geom_point(color = "red", size = 2) +
    labs(x = "Principal Component", y = "% Variance Explained") +
    theme_minimal()
}
```

```{r pca-scree-commentary, results='asis'}
render_commentary("pca_scree", "pca_scree")
```

## Outlier Detection

```{r outliers}
if (!is.null(params$outlier_detection)) {
  outliers <- params$outlier_detection
  n_outliers <- sum(outliers$is_outlier)

  if (n_outliers > 0) {
    cat("**Warning:** ", n_outliers, " potential outlier sample(s) detected:\n\n")
    DT::datatable(
      outliers[outliers$is_outlier, ],
      caption = "Flagged Outlier Samples",
      rownames = FALSE
    )
  } else {
    cat("No outlier samples detected based on PCA distance and correlation metrics.")
  }
}
```

------------------------------------------------------------------------

# Gene Filtering

```{r filtering-stats}
if (!is.null(params$filtering_stats)) {
  knitr::kable(
    params$filtering_stats,
    caption = "Gene Filtering Statistics",
    col.names = c("Metric", "Value")
  )
}
```

------------------------------------------------------------------------

# Gene Annotation

```{r annotation-stats}
if (!is.null(params$annotation_stats)) {
  annot_df <- data.frame(
    Metric = c("Source", "Total Genes", "Annotated Genes", "Success Rate"),
    Value = c(
      params$annotation_stats$source,
      params$annotation_stats$total_genes,
      params$annotation_stats$annotated_genes,
      paste0(round(params$annotation_stats$success_rate * 100, 1), "%")
    )
  )
  knitr::kable(annot_df, caption = "Gene Annotation Statistics")
}
```

------------------------------------------------------------------------

# Differential Expression Analysis

## Summary

```{r de-summary}
if (!is.null(params$de_summary)) {
  DT::datatable(
    params$de_summary,
    caption = "Differential Expression Summary",
    rownames = FALSE
  )
}
```

## Results by Contrast

```{r de-results, results='asis'}
if (!is.null(params$de_results)) {
  for (contrast_name in names(params$de_results)) {
    res <- params$de_results[[contrast_name]]

    if (is.null(res) || nrow(res) == 0) next

    cat("\n\n### ", contrast_name, "\n\n")

    # Volcano plot
    res_plot <- res[!is.na(res$padj), ]

    p <- ggplot(res_plot, aes(x = log2FoldChange, y = -log10(padj))) +
      geom_point(aes(color = direction), alpha = 0.5, size = 1) +
      scale_color_manual(values = c("up" = "red", "down" = "blue", "ns" = "grey60")) +
      geom_hline(yintercept = -log10(0.05), linetype = "dashed", color = "grey40") +
      geom_vline(xintercept = c(-1, 1), linetype = "dashed", color = "grey40") +
      labs(
        title = paste("Volcano Plot:", contrast_name),
        x = "log2 Fold Change",
        y = "-log10(adjusted p-value)"
      ) +
      theme_minimal() +
      theme(legend.position = "bottom")

    print(p)

    # Commentary for volcano plot
    clean_name <- gsub("[^a-zA-Z0-9_-]", "_", contrast_name)
    volcano_id <- paste0("volcano_", clean_name)
    cat("\n")
    render_commentary(volcano_id, "volcano")
    cat("\n")

    # MA plot
    p_ma <- ggplot(res_plot, aes(x = log10(baseMean + 1), y = log2FoldChange)) +
      geom_point(aes(color = direction), alpha = 0.5, size = 1) +
      scale_color_manual(values = c("up" = "red", "down" = "blue", "ns" = "grey60")) +
      geom_hline(yintercept = 0, color = "grey40") +
      labs(
        title = paste("MA Plot:", contrast_name),
        x = "log10(Mean Expression)",
        y = "log2 Fold Change"
      ) +
      theme_minimal() +
      theme(legend.position = "bottom")

    print(p_ma)

    # Commentary for MA plot
    ma_id <- paste0("ma_", clean_name)
    cat("\n")
    render_commentary(ma_id, "ma_plot")
    cat("\n")

    # Top genes table
    top_genes <- head(res[res$significant == TRUE, ], 20)

    if (nrow(top_genes) > 0) {
      cat("\n\n**Top 20 Significant Genes:**\n\n")

      # Select columns to display
      display_cols <- intersect(
        c("gene_id", "symbol", "log2FoldChange", "padj", "baseMean"),
        colnames(top_genes)
      )

      print(knitr::kable(
        top_genes[, display_cols],
        digits = 3,
        row.names = FALSE
      ))
    }
  }
}
```

------------------------------------------------------------------------

# Pathway Analysis

```{r pathway-results, results='asis'}
if (!is.null(params$pathway_results) && length(params$pathway_results) > 0) {

  for (contrast_name in names(params$pathway_results)) {
    contrast_res <- params$pathway_results[[contrast_name]]

    if (length(contrast_res) == 0) next

    cat("\n\n## ", contrast_name, "\n\n")

    for (analysis_name in names(contrast_res)) {
      res_df <- contrast_res[[analysis_name]]

      if (is.null(res_df) || nrow(res_df) == 0) next

      cat("\n\n### ", analysis_name, "\n\n")

      # Get top pathways
      if ("padj" %in% colnames(res_df)) {
        top_pathways <- head(res_df[order(res_df$padj), ], 15)
      } else {
        next
      }

      if (nrow(top_pathways) < 1) next

      # Truncate pathway names for display
      top_pathways$pathway_short <- substr(top_pathways$pathway, 1, 60)

      # Plot
      if ("NES" %in% colnames(top_pathways)) {
        p <- ggplot(top_pathways, aes(x = NES, y = reorder(pathway_short, NES))) +
          geom_point(aes(size = size, color = -log10(padj))) +
          scale_color_gradient(low = "blue", high = "red") +
          labs(x = "Normalized Enrichment Score", y = "") +
          theme_minimal() +
          theme(axis.text.y = element_text(size = 8))
      } else {
        p <- ggplot(top_pathways, aes(x = -log10(pvalue), y = reorder(pathway_short, -log10(pvalue)))) +
          geom_point(aes(size = overlap, color = -log10(padj))) +
          scale_color_gradient(low = "blue", high = "red") +
          labs(x = "-log10(p-value)", y = "") +
          theme_minimal() +
          theme(axis.text.y = element_text(size = 8))
      }

      print(p)

      # Commentary for pathway plot
      clean_contrast <- gsub("[^a-zA-Z0-9_-]", "_", contrast_name)
      pathway_id <- paste0("pathway_", clean_contrast, "_", analysis_name)
      cat("\n")
      render_commentary(pathway_id, "dotplot")
      cat("\n")

      # Table of significant pathways
      sig_pathways <- res_df[!is.na(res_df$padj) & res_df$padj < 0.05, ]

      if (nrow(sig_pathways) > 0) {
        cat("\n\n**Significant Pathways (padj < 0.05):** ", nrow(sig_pathways), "\n\n")

        display_cols <- intersect(
          c("pathway", "size", "NES", "pvalue", "padj"),
          colnames(sig_pathways)
        )

        print(knitr::kable(
          head(sig_pathways[, display_cols], 20),
          digits = 4,
          row.names = FALSE
        ))
      }
    }
  }
} else {
  cat("No pathway analysis results available.")
}
```

------------------------------------------------------------------------

# Commentary Summary

```{r commentary-summary}
if (!is.null(params$commentary_tbl) && nrow(params$commentary_tbl) > 0) {
  cat("## Figure Commentary Overview\n\n")

  summary_tbl <- params$commentary_tbl[, c("figure_id", "title", "confidence", "backend")]

  DT::datatable(
    summary_tbl,
    caption = "Generated Commentary Summary",
    options = list(pageLength = 20),
    rownames = FALSE
  )
} else {
  cat("Figure commentary was not generated for this analysis.\n")
  cat("To enable commentary, set `commentary_enabled: true` in config.yml\n")
}
```

------------------------------------------------------------------------

# Session Information

```{r session-info}
sessionInfo()
```
