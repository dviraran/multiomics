---
title: "Metabolomics Analysis Report"
author: "Generated by Metabolomics Pipeline"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_depth: 3
    toc_float: true
    theme: cosmo
    highlight: tango
    code_folding: hide
    fig_width: 10
    fig_height: 7
params:
  results: NULL
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  warning = FALSE,
  message = FALSE,
  fig.align = "center"
)

library(tidyverse)
library(knitr)
library(DT)
library(plotly)

if (!is.null(params$results)) {
  results <- params$results
} else {
  library(targets)
  results <- tar_read(analysis_results)
}

config <- results$config
```

# Executive Summary

This report presents the results of a comprehensive metabolomics analysis. The pipeline includes quality control, normalization, batch correction, differential abundance testing, and enrichment analysis.

```{r summary_stats}
summary_stats <- data.frame(
  Metric = c(
    "Data type",
    "Total features",
    "Total samples",
    "Biological samples",
    "QC samples",
    "Blank samples",
    "Features after filtering",
    "Normalization method",
    "Imputation method",
    "Number of contrasts"
  ),
  Value = c(
    config$input$data_type,
    nrow(results$ingested$matrix),
    ncol(results$ingested$matrix),
    length(results$ingested$sample_roles$biological_samples),
    length(results$ingested$sample_roles$qc_samples),
    length(results$ingested$sample_roles$blank_samples),
    nrow(results$filtered$matrix),
    config$processing$normalization_method,
    config$imputation$method,
    length(config$design$contrasts)
  )
)

kable(summary_stats, caption = "Analysis Summary")
```

# Experimental Design

```{r design_info, results='asis'}
cat("**Organism:**", config$input$organism, "\n\n")
cat("**Design formula:**", config$design$design_formula, "\n\n")
cat("**Contrasts:**\n")
for (contrast in config$design$contrasts) {
  cat("  -", contrast, "\n")
}
```

## Sample Overview

```{r sample_overview}
metadata <- results$ingested$metadata
condition_col <- config$design$condition_column

condition_counts <- table(metadata[[condition_col]])
condition_df <- data.frame(
  Condition = names(condition_counts),
  n_samples = as.numeric(condition_counts)
)

kable(condition_df, caption = "Samples per Condition")
```

```{r sample_types}
if (results$ingested$sample_roles$has_sample_types) {
  kable(results$ingested$sample_roles$summary, caption = "Sample Types")
}
```

# Quality Control

## Initial Data Quality

```{r initial_qc_metrics}
sample_metrics <- results$initial_qc$sample_metrics

# Total signal distribution
ggplot(sample_metrics, aes(x = reorder(sample_id, -total_signal), y = total_signal, fill = sample_type)) +
  geom_bar(stat = "identity") +
  labs(title = "Total Signal per Sample", x = "Sample", y = "Total Signal") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, size = 6))
```

```{r features_detected}
ggplot(sample_metrics, aes(x = reorder(sample_id, -n_detected), y = n_detected, fill = sample_type)) +
  geom_bar(stat = "identity") +
  labs(title = "Features Detected per Sample", x = "Sample", y = "Number of Features") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, size = 6))
```

## Filtering Summary

```{r filtering_summary}
filter_log <- results$filtered$filter_log
kable(filter_log, caption = "Feature Filtering Steps")
```

```{r filtering_plot}
if (nrow(filter_log) > 0) {
  filter_log$step <- factor(filter_log$step, levels = filter_log$step)

  ggplot(filter_log, aes(x = step, y = features_after)) +
    geom_bar(stat = "identity", fill = "#0072B2") +
    geom_text(aes(label = features_after), vjust = -0.3) +
    labs(title = "Features Retained After Each Filter", x = "Step", y = "Features") +
    theme_minimal() +
    theme(axis.text.x = element_text(angle = 45, hjust = 1))
}
```

## Normalization

The data was normalized using **`r config$processing$normalization_method`** normalization after **`r config$processing$transform`** transformation.

```{r normalization_boxplot, fig.height=8}
mat_norm <- results$normalized$matrix
metadata <- results$normalized$metadata
sample_col <- config$input$sample_id_column
condition_col <- config$design$condition_column

if (ncol(mat_norm) <= 50) {
  boxplot_data <- reshape2::melt(mat_norm)
  colnames(boxplot_data) <- c("feature", "sample", "intensity")
  boxplot_data$condition <- metadata[[condition_col]][match(boxplot_data$sample, metadata[[sample_col]])]

  ggplot(boxplot_data, aes(x = sample, y = intensity, fill = condition)) +
    geom_boxplot(outlier.size = 0.5) +
    labs(title = "Normalized Intensity Distribution", x = "Sample", y = "Log2 Intensity") +
    theme_minimal() +
    theme(axis.text.x = element_text(angle = 90, hjust = 1, size = 6))
}
```

## Batch Correction

```{r batch_correction, results='asis'}
if (results$batch_corrected$corrected) {
  cat("**Batch correction method:**", results$batch_corrected$method, "\n\n")
  if (!is.null(results$batch_corrected$correction_details)) {
    cat("Correction was applied successfully.\n")
  }
} else {
  cat("Batch correction was not applied.\n")
}
```

## Missing Value Analysis

```{r missingness_summary}
miss_summary <- results$imputed$missingness$summary
kable(miss_summary, caption = "Missingness Summary")
```

```{r mnar_plot}
miss_df <- results$imputed$missingness$per_feature

ggplot(miss_df, aes(x = mean_intensity, y = pct_missing)) +
  geom_point(alpha = 0.3, size = 0.5) +
  geom_smooth(method = "loess", color = "red") +
  labs(
    title = "Missingness vs Intensity (MNAR Diagnostic)",
    subtitle = paste("Pattern:", results$imputed$missingness$mnar_analysis$pattern),
    x = "Mean Intensity", y = "% Missing"
  ) +
  theme_minimal()
```

**Imputation method:** `r config$imputation$method`

# Exploratory Analysis

## Principal Component Analysis

```{r pca_plot}
pca_coords <- results$exploratory$pca$coordinates
var_explained <- results$exploratory$pca$variance_explained

ggplot(pca_coords, aes(x = PC1, y = PC2, color = condition, shape = sample_type)) +
  geom_point(size = 3, alpha = 0.8) +
  labs(
    title = "PCA: PC1 vs PC2",
    x = paste0("PC1 (", round(var_explained[1], 1), "%)"),
    y = paste0("PC2 (", round(var_explained[2], 1), "%)")
  ) +
  theme_minimal()
```

```{r pca_interactive}
if (requireNamespace("plotly", quietly = TRUE)) {
  p <- ggplot(pca_coords, aes(x = PC1, y = PC2, color = condition, label = sample_id)) +
    geom_point(size = 3) +
    labs(title = "PCA (Interactive)") +
    theme_minimal()
  ggplotly(p)
}
```

```{r scree}
scree_df <- data.frame(
  PC = factor(names(var_explained), levels = names(var_explained)),
  variance = var_explained,
  cumulative = cumsum(var_explained)
)

ggplot(scree_df, aes(x = PC, y = variance)) +
  geom_bar(stat = "identity", fill = "#0072B2") +
  geom_line(aes(y = cumulative, group = 1), color = "red") +
  geom_point(aes(y = cumulative), color = "red") +
  labs(title = "PCA Scree Plot", x = "Component", y = "% Variance") +
  theme_minimal()
```

## UMAP

```{r umap, eval=!is.null(results$exploratory$umap)}
if (!is.null(results$exploratory$umap)) {
  umap_coords <- results$exploratory$umap$coordinates

  ggplot(umap_coords, aes(x = UMAP1, y = UMAP2, color = condition)) +
    geom_point(size = 3) +
    labs(title = "UMAP") +
    theme_minimal()
}
```

## Outlier Detection

```{r outliers}
outliers <- results$exploratory$outliers$flagged_samples
outlier_flagged <- outliers[outliers$is_outlier, ]

if (nrow(outlier_flagged) > 0) {
  kable(outlier_flagged[, c("sample_id", "pca_outlier", "correlation_outlier", "low_signal_outlier", "reason")],
        caption = "Flagged Outlier Samples (NOT auto-removed)")
} else {
  cat("No outlier samples were flagged.\n")
}
```

# Differential Abundance Analysis

```{r de_check, results='asis'}
if (is.null(results$differential)) {
  cat("Differential analysis was not performed.\n")
}
```

```{r de_results, eval=!is.null(results$differential)}
de_summary <- results$differential$summary
kable(de_summary, caption = "Differential Analysis Summary")
```

```{r de_barplot, eval=!is.null(results$differential)}
de_long <- de_summary %>%
  select(contrast, up_regulated, down_regulated) %>%
  pivot_longer(cols = c(up_regulated, down_regulated), names_to = "direction", values_to = "count")

de_long$direction <- gsub("_regulated", "", de_long$direction)

ggplot(de_long, aes(x = contrast, y = count, fill = direction)) +
  geom_bar(stat = "identity", position = "dodge") +
  scale_fill_manual(values = c("up" = "#D55E00", "down" = "#0072B2")) +
  labs(title = "Significant Features by Contrast", x = "Contrast", y = "Count") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

## Volcano Plots {.tabset}

```{r volcano_plots, results='asis', eval=!is.null(results$differential)}
for (contrast_name in names(results$differential$results)) {
  cat(paste0("\n### ", contrast_name, "\n\n"))

  tt <- results$differential$results[[contrast_name]]$table

  volcano_df <- tt
  volcano_df$neg_log10_pval <- -log10(volcano_df$P.Value)
  volcano_df$status <- "Not significant"
  volcano_df$status[volcano_df$significant & volcano_df$direction == "up"] <- "Up"
  volcano_df$status[volcano_df$significant & volcano_df$direction == "down"] <- "Down"

  p <- ggplot(volcano_df, aes(x = log2FC, y = neg_log10_pval, color = status)) +
    geom_point(alpha = 0.5, size = 1) +
    scale_color_manual(values = c("Up" = "#D55E00", "Down" = "#0072B2", "Not significant" = "grey60")) +
    geom_vline(xintercept = c(-config$differential$log2fc_threshold, config$differential$log2fc_threshold),
               linetype = "dashed") +
    geom_hline(yintercept = -log10(config$differential$adj_pvalue_threshold), linetype = "dashed") +
    labs(title = paste("Volcano Plot:", contrast_name), x = "Log2 Fold Change", y = "-Log10(P-value)") +
    theme_minimal()

  print(p)
  cat("\n\n")
}
```

## Top Differential Features {.tabset}

```{r top_de, results='asis', eval=!is.null(results$differential)}
for (contrast_name in names(results$differential$results)) {
  cat(paste0("\n### ", contrast_name, "\n\n"))

  tt <- results$differential$results[[contrast_name]]$table
  top_de <- head(tt[tt$significant, ], 20)

  if (nrow(top_de) > 0) {
    display_cols <- intersect(c("feature_id", "metabolite_name", "log2FC", "P.Value", "adj.P.Val", "direction"),
                              colnames(top_de))
    top_display <- top_de[, display_cols]
    top_display$log2FC <- round(top_display$log2FC, 3)
    top_display$P.Value <- format(top_display$P.Value, scientific = TRUE, digits = 3)
    top_display$adj.P.Val <- format(top_display$adj.P.Val, scientific = TRUE, digits = 3)

    if (requireNamespace("DT", quietly = TRUE)) {
      print(DT::datatable(top_display, options = list(pageLength = 10)))
    } else {
      print(kable(top_display))
    }
  } else {
    cat("No significant features.\n")
  }
  cat("\n\n")
}
```

# Enrichment Analysis

```{r enrichment_check, results='asis'}
if (is.null(results$enrichment)) {
  cat("Enrichment analysis was not performed. This may be due to:\n\n")
  cat("- No pathway mapping file provided\n")
  cat("- No GMT file provided\n")
  cat("- No chemical class annotations available\n\n")
  cat("To enable enrichment, provide pathway_mapping, gmt_file, or annotation_table with class column.\n")
}
```

```{r enrichment_results, results='asis', eval=!is.null(results$enrichment)}
for (contrast_name in names(results$enrichment$results)) {
  cat(paste0("\n## ", contrast_name, " {.tabset}\n\n"))

  enrich_data <- results$enrichment$results[[contrast_name]]

  # Pathway results
  if (!is.null(enrich_data$pathway) && nrow(enrich_data$pathway) > 0) {
    cat("\n### Pathway Enrichment\n\n")

    top_pathways <- head(enrich_data$pathway[enrich_data$pathway$p.adjust < 0.2, ], 15)

    if (nrow(top_pathways) > 0) {
      top_pathways$short_name <- substr(top_pathways$pathway_name, 1, 40)

      p <- ggplot(top_pathways,
        aes(x = -log10(p.adjust), y = reorder(short_name, -log10(p.adjust)), size = n_overlap)) +
        geom_point(color = "#0072B2") +
        labs(title = "Pathway Enrichment", x = "-Log10(Adj P)", y = "Pathway") +
        theme_minimal()

      print(p)
      print(kable(top_pathways[, c("pathway_name", "n_pathway", "n_overlap", "p.adjust")]))
    }
    cat("\n\n")
  }

  # Class results
  if (!is.null(enrich_data$class) && nrow(enrich_data$class) > 0) {
    cat("\n### Chemical Class Enrichment\n\n")

    top_classes <- head(enrich_data$class[enrich_data$class$p.adjust < 0.2, ], 15)

    if (nrow(top_classes) > 0) {
      p <- ggplot(top_classes,
        aes(x = -log10(p.adjust), y = reorder(class, -log10(p.adjust)), fill = pct_up > 50)) +
        geom_bar(stat = "identity") +
        scale_fill_manual(values = c("TRUE" = "#D55E00", "FALSE" = "#0072B2")) +
        labs(title = "Chemical Class Enrichment", x = "-Log10(Adj P)", y = "Class") +
        theme_minimal()

      print(p)
      print(kable(top_classes[, c("class", "n_class", "n_significant", "pct_up", "p.adjust")]))
    }
    cat("\n\n")
  }
}
```

```{r qea_results, results='asis', eval=!is.null(results$qea) && !is.null(results$qea$pathway_results_df)}
if (!is.null(results$qea) && !is.null(results$qea$pathway_results_df) && nrow(results$qea$pathway_results_df) > 0) {
  cat("\n## Global Test QEA (MetaboAnalyst) {.tabset}\n\n")

  qea_df <- results$qea$pathway_results_df
  top_qea <- head(qea_df[order(qea_df$p.adj), ], 20)
  display_cols <- intersect(c("pathway", "p.adj", "topology", "hits", "total"), colnames(top_qea))
  if (length(display_cols) > 0) print(kable(top_qea[, display_cols]))

  # Include saved plots if available
  if (!is.null(results$qea$saved_paths$barplot_path) && file.exists(results$qea$saved_paths$barplot_path)) {
    cat("\n### QEA Barplot\n\n")
    knitr::include_graphics(results$qea$saved_paths$barplot_path)
  }
  if (!is.null(results$qea$saved_paths$dotplot_path) && file.exists(results$qea$saved_paths$dotplot_path)) {
    cat("\n### QEA Dotplot\n\n")
    knitr::include_graphics(results$qea$saved_paths$dotplot_path)
  }
}
```

# Annotation Summary

```{r annotation_summary}
if (!is.null(results$annotation_summary)) {
  kable(results$annotation_summary, caption = "Annotation Coverage")
}
```

# Methods Summary

```{r methods}
methods_df <- data.frame(
  Step = c(
    "Transformation",
    "Normalization",
    "Batch correction",
    "Imputation",
    "Global presence filter",
    "Group presence filter",
    "Statistical method",
    "FDR threshold",
    "Log2FC threshold"
  ),
  Setting = c(
    config$processing$transform,
    config$processing$normalization_method,
    config$batch_correction$method,
    config$imputation$method,
    paste0(config$filtering$global_min_presence * 100, "%"),
    paste0(config$filtering$group_min_presence * 100, "%"),
    config$differential$method,
    config$differential$adj_pvalue_threshold,
    config$differential$log2fc_threshold
  )
)

kable(methods_df, caption = "Analysis Parameters")
```

# Session Info

```{r session_info}
sessionInfo()
```

---

*Report generated on `r Sys.time()` using the Metabolomics Analysis Pipeline.*
