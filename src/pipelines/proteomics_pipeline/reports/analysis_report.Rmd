---
title: "Proteomics Analysis Report"
author: "Generated by Proteomics Pipeline"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_depth: 3
    toc_float: true
    theme: cosmo
    highlight: tango
    code_folding: hide
    fig_width: 10
    fig_height: 7
params:
  results: NULL
  commentary_tbl: NULL
---

<style>
/* Commentary block styling */
.commentary-block {
  background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
  border-left: 4px solid #6c757d;
  border-radius: 0 8px 8px 0;
  padding: 15px 20px;
  margin: 15px 0;
  font-size: 0.95em;
  box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}

.commentary-block.ai-generated {
  border-left-color: #0d6efd;
  background: linear-gradient(135deg, #f0f7ff 0%, #e7f1ff 100%);
}

.commentary-block.data-driven {
  border-left-color: #198754;
  background: linear-gradient(135deg, #f0fff4 0%, #e6f7ed 100%);
}

.commentary-block h4 {
  margin: 0 0 10px 0;
  color: #495057;
  font-size: 1.05em;
  display: flex;
  align-items: center;
  gap: 8px;
}

.commentary-block h4::before {
  content: "";
  font-size: 1.2em;
}

.commentary-block.ai-generated h4::before {
  content: "\1F916";
}

.commentary-block.data-driven h4::before {
  content: "\1F4CA";
}

.commentary-section {
  margin: 10px 0 5px 0;
  padding: 0;
}

.commentary-section-title {
  font-weight: 600;
  color: #495057;
  font-size: 0.9em;
  margin-bottom: 5px;
}

.commentary-section ul {
  margin: 5px 0;
  padding-left: 20px;
}

.commentary-section li {
  margin-bottom: 3px;
  line-height: 1.4;
}

.commentary-what-is-this {
  font-style: italic;
  color: #6c757d;
  margin-bottom: 10px;
  padding-bottom: 10px;
  border-bottom: 1px dashed #dee2e6;
}

.commentary-issues {
  background: rgba(255, 193, 7, 0.1);
  border-radius: 4px;
  padding: 8px 12px;
  margin-top: 10px;
}

.commentary-issues .commentary-section-title {
  color: #856404;
}

.commentary-next-steps {
  background: rgba(13, 110, 253, 0.05);
  border-radius: 4px;
  padding: 8px 12px;
  margin-top: 10px;
}

.commentary-next-steps .commentary-section-title {
  color: #084298;
}

.static-explanation {
  margin-top: 10px;
  padding: 10px;
  background: #f8f9fa;
  border-radius: 4px;
  font-size: 0.85em;
}

.static-explanation summary {
  cursor: pointer;
  color: #6c757d;
}

.static-explanation p {
  margin: 10px 0 0 0;
  color: #495057;
}
</style>

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  warning = FALSE,
  message = FALSE,
  fig.align = "center"
)

library(tidyverse)
library(knitr)
library(DT)
library(plotly)

# Get results from params or load from targets
if (!is.null(params$results)) {
  results <- params$results
} else {
  # Load from targets if running interactively
  library(targets)
  results <- tar_read(analysis_results)
}

config <- results$config

# Get commentary table
commentary_tbl <- if (!is.null(params$commentary_tbl)) {
  params$commentary_tbl
} else if (!is.null(results$commentary)) {
  results$commentary
} else {
  NULL
}

# Source commentary functions if available
tryCatch({
  source(here::here("R", "09_commentary.R"))
  commentary_available <- TRUE
}, error = function(e) {
  commentary_available <<- FALSE
})

# Helper function to get commentary for a figure
get_commentary <- function(figure_id) {
  if (is.null(commentary_tbl)) return(NULL)
  tryCatch({
    get_figure_commentary(commentary_tbl, figure_id)
  }, error = function(e) NULL)
}

# Helper to render commentary block
render_commentary <- function(figure_id, plot_type = NULL) {
  commentary <- get_commentary(figure_id)

  if (!is.null(commentary)) {
    html_output <- format_commentary_html(commentary)
    cat(html_output)
  } else if (!is.null(plot_type)) {
    # Show static explanation if available
    static <- get_static_explanation(plot_type)
    if (static != "") {
      cat(static)
    }
  } else {
    cat("<div class='commentary-block commentary-unavailable'><p><em>Commentary unavailable for this figure.</em></p></div>")
  }
}
```

# Executive Summary

This report presents the results of a comprehensive proteomics analysis pipeline. The analysis includes quality control, normalization, differential abundance testing, and pathway enrichment.

```{r summary_stats}
# Create summary table
summary_stats <- data.frame(
  Metric = c(
    "Total features (proteins/peptides)",
    "Total samples",
    "Features after filtering",
    "Normalization method",
    "Imputation method",
    "Number of contrasts analyzed"
  ),
  Value = c(
    nrow(results$ingested$matrix),
    ncol(results$ingested$matrix),
    nrow(results$filtered$matrix),
    config$processing$normalization_method,
    config$imputation$method,
    length(config$design$contrasts)
  )
)

kable(summary_stats, caption = "Analysis Summary")
```

# Input Data

## Experimental Design

```{r design_info}
# Show experimental design
cat("**Organism:**", config$input$organism, "\n\n")
cat("**Feature type:**", config$input$feature_id_type, "\n\n")
cat("**Design formula:**", config$design$design_formula, "\n\n")
cat("**Contrasts:**\n")
for (contrast in config$design$contrasts) {
  cat("  -", contrast, "\n")
}
```

## Sample Overview

```{r sample_overview}
metadata <- results$ingested$metadata
condition_col <- config$design$condition_column

# Sample counts per condition
condition_counts <- table(metadata[[condition_col]])
condition_df <- data.frame(
  Condition = names(condition_counts),
  n_samples = as.numeric(condition_counts)
)

kable(condition_df, caption = "Samples per Condition")
```

```{r sample_overview_plot}
ggplot(condition_df, aes(x = Condition, y = n_samples, fill = Condition)) +
  geom_bar(stat = "identity") +
  labs(title = "Sample Distribution by Condition",
       y = "Number of Samples") +
  theme_minimal() +
  theme(legend.position = "none")
```

## Data Validation

```{r validation}
validation <- results$ingested$validation

validation_df <- data.frame(
  Metric = c("Number of features", "Number of samples", "Overall % missing",
             "Features with duplicates", "Has negative values"),
  Value = c(
    validation$n_features,
    validation$n_samples,
    round(validation$pct_missing, 2),
    validation$duplicate_features,
    ifelse(validation$has_negative, "Yes", "No")
  )
)

kable(validation_df, caption = "Data Validation Summary")
```

```{r validation_issues, results='asis'}
if (length(validation$issues) > 0) {
  cat("\n### Validation Notes\n\n")
  for (issue in validation$issues) {
    cat("- ", issue, "\n")
  }
}
```

# Quality Control

## Filtering Summary

```{r filtering_summary}
filter_log <- results$filtered$filter_log

kable(filter_log, caption = "Feature Filtering Steps")
```

```{r filtering_plot}
filter_log$step <- factor(filter_log$step, levels = filter_log$step)

ggplot(filter_log, aes(x = step, y = features_after)) +
  geom_bar(stat = "identity", fill = "#0072B2") +
  geom_text(aes(label = features_after), vjust = -0.3) +
  labs(title = "Features Retained After Each Filtering Step",
       x = "Filtering Step",
       y = "Number of Features") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

## Normalization

The data was normalized using **`r config$processing$normalization_method`** normalization.

```{r normalization_boxplot, fig.height=8}
# Get normalized data
mat_norm <- results$normalized$matrix
metadata <- results$normalized$metadata
sample_col <- config$input$sample_id_column
condition_col <- config$design$condition_column

# Prepare data for boxplot
if (ncol(mat_norm) <= 50) {
  boxplot_data <- reshape2::melt(mat_norm)
  colnames(boxplot_data) <- c("feature", "sample", "intensity")
  boxplot_data$condition <- metadata[[condition_col]][match(boxplot_data$sample, metadata[[sample_col]])]

  ggplot(boxplot_data, aes(x = sample, y = intensity, fill = condition)) +
    geom_boxplot(outlier.size = 0.5) +
    labs(title = "Normalized Intensity Distribution by Sample",
         x = "Sample",
         y = "Log2 Intensity") +
    theme_minimal() +
    theme(axis.text.x = element_text(angle = 90, hjust = 1, size = 6),
          legend.position = "bottom")
} else {
  # For many samples, show density plot
  mat_long <- reshape2::melt(mat_norm)
  colnames(mat_long) <- c("feature", "sample", "intensity")

  ggplot(mat_long, aes(x = intensity, color = sample)) +
    geom_density(show.legend = FALSE, alpha = 0.5) +
    labs(title = "Normalized Intensity Density",
         x = "Log2 Intensity",
         y = "Density") +
    theme_minimal()
}
```

## Missing Value Analysis

```{r missingness_summary}
miss_summary <- results$imputed$missingness_analysis$summary
kable(miss_summary, caption = "Missingness Summary")
```

```{r mnar_diagnostic, fig.height=6}
# MNAR diagnostic plot
miss_per_feature <- results$imputed$missingness_analysis$per_feature

ggplot(miss_per_feature, aes(x = mean_intensity, y = pct_missing)) +
  geom_point(alpha = 0.3, size = 0.5) +
  geom_smooth(method = "loess", color = "red", se = TRUE) +
  labs(title = "Missingness vs Mean Intensity (MNAR Diagnostic)",
       subtitle = paste("Pattern:", results$imputed$missingness_analysis$mnar_evidence$pattern),
       x = "Mean Log2 Intensity",
       y = "% Missing") +
  theme_minimal()
```

**Imputation method used:** `r config$imputation$method`

```{r imputation_pattern, results='asis'}
pattern <- results$imputed$missingness_analysis$mnar_evidence$pattern
if (grepl("MNAR", pattern)) {
  cat("\nThe missingness pattern suggests **left-censored (MNAR)** data, which is typical for mass spectrometry data where low-abundance proteins are more likely to be missing.\n")
} else if (grepl("MCAR", pattern)) {
  cat("\nThe missingness pattern appears to be **random (MCAR-like)**, suggesting that missingness is not strongly associated with protein abundance.\n")
}
```

## Principal Component Analysis

```{r pca_plot, fig.height=7}
pca_coords <- results$qc$pca$coordinates
var_explained <- results$qc$pca$variance_explained

ggplot(pca_coords, aes(x = PC1, y = PC2, color = condition)) +
  geom_point(size = 3, alpha = 0.8) +
  labs(title = "PCA: PC1 vs PC2",
       x = paste0("PC1 (", round(var_explained[1], 1), "%)"),
       y = paste0("PC2 (", round(var_explained[2], 1), "%)"),
       color = "Condition") +
  theme_minimal() +
  theme(legend.position = "right")
```

```{r pca_commentary, results='asis'}
render_commentary("pca_pc1_pc2", "pca")
```

```{r pca_interactive}
if (requireNamespace("plotly", quietly = TRUE)) {
  p <- ggplot(pca_coords, aes(x = PC1, y = PC2, color = condition, label = sample)) +
    geom_point(size = 3, alpha = 0.8) +
    labs(title = "PCA (Interactive)",
         x = paste0("PC1 (", round(var_explained[1], 1), "%)"),
         y = paste0("PC2 (", round(var_explained[2], 1), "%)")) +
    theme_minimal()

  ggplotly(p)
}
```

```{r scree_plot}
scree_df <- data.frame(
  PC = factor(names(var_explained), levels = names(var_explained)),
  variance = var_explained,
  cumulative = cumsum(var_explained)
)

ggplot(scree_df, aes(x = PC, y = variance)) +
  geom_bar(stat = "identity", fill = "#0072B2") +
  geom_line(aes(y = cumulative, group = 1), color = "red", size = 1) +
  geom_point(aes(y = cumulative), color = "red", size = 2) +
  labs(title = "PCA Scree Plot",
       x = "Principal Component",
       y = "% Variance Explained") +
  theme_minimal()
```

```{r scree_commentary, results='asis'}
render_commentary("pca_scree")
```

## Sample Correlation

```{r correlation_summary}
cor_summary <- results$qc$correlation$summary
kable(cor_summary, caption = "Sample Correlation Summary")
```

```{r correlation_heatmap, fig.height=8, fig.width=10, eval=requireNamespace("pheatmap", quietly = TRUE)}
cor_mat <- results$qc$correlation$correlation_matrix
metadata <- results$imputed$metadata

# Annotation
annotation_df <- data.frame(
  Condition = metadata[[condition_col]],
  row.names = colnames(cor_mat)
)

if (ncol(cor_mat) <= 100) {
  pheatmap::pheatmap(
    cor_mat,
    annotation_col = annotation_df,
    annotation_row = annotation_df,
    show_rownames = ncol(cor_mat) <= 50,
    show_colnames = ncol(cor_mat) <= 50,
    main = "Sample Correlation Heatmap"
  )
}
```

```{r correlation_commentary, results='asis'}
render_commentary("correlation_heatmap", "correlation")
```

## Outlier Detection

```{r outlier_report}
outliers <- results$qc$outliers$flagged_samples

outlier_flagged <- outliers[outliers$is_outlier, ]

if (nrow(outlier_flagged) > 0) {
  kable(outlier_flagged[, c("sample", "pca_outlier", "correlation_outlier", "reason")],
        caption = "Flagged Outlier Samples (NOT auto-removed)")
} else {
  cat("No outlier samples were flagged.\n")
}
```

# Differential Abundance Analysis

## Summary

```{r de_summary}
de_summary <- results$differential$summary
kable(de_summary, caption = "Differential Analysis Summary")
```

```{r de_summary_plot}
de_summary_long <- de_summary %>%
  select(contrast, up_regulated, down_regulated) %>%
  pivot_longer(cols = c(up_regulated, down_regulated),
               names_to = "direction",
               values_to = "count")

de_summary_long$direction <- gsub("_regulated", "", de_summary_long$direction)

ggplot(de_summary_long, aes(x = contrast, y = count, fill = direction)) +
  geom_bar(stat = "identity", position = "dodge") +
  scale_fill_manual(values = c("up" = "#D55E00", "down" = "#0072B2")) +
  labs(title = "Differential Proteins by Contrast",
       x = "Contrast",
       y = "Number of Significant Proteins",
       fill = "Direction") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

## Volcano Plots {.tabset}

```{r volcano_plots, results='asis', fig.height=6}
for (contrast_name in names(results$differential$results)) {
  cat(paste0("\n### ", contrast_name, "\n\n"))

  tt <- results$differential$results[[contrast_name]]$table

  # Prepare volcano data
  volcano_df <- tt
  volcano_df$neg_log10_pval <- -log10(volcano_df$P.Value)
  volcano_df$status <- "Not significant"
  volcano_df$status[volcano_df$significant & volcano_df$direction == "up"] <- "Up-regulated"
  volcano_df$status[volcano_df$significant & volcano_df$direction == "down"] <- "Down-regulated"

  adj_pval_thresh <- config$differential$adj_pvalue_threshold
  log2fc_thresh <- config$differential$log2fc_threshold

  p <- ggplot(volcano_df, aes(x = log2FC, y = neg_log10_pval, color = status)) +
    geom_point(alpha = 0.5, size = 1) +
    scale_color_manual(values = c("Up-regulated" = "#D55E00",
                                  "Down-regulated" = "#0072B2",
                                  "Not significant" = "grey60")) +
    geom_vline(xintercept = c(-log2fc_thresh, log2fc_thresh), linetype = "dashed", color = "grey40") +
    geom_hline(yintercept = -log10(adj_pval_thresh), linetype = "dashed", color = "grey40") +
    labs(title = paste("Volcano Plot:", contrast_name),
         x = "Log2 Fold Change",
         y = "-Log10(P-value)") +
    theme_minimal() +
    theme(legend.position = "bottom")

  print(p)

  # Render commentary for this volcano plot
  clean_name <- gsub(" ", "_", gsub("-", "_vs_", contrast_name))
  volcano_id <- paste0("volcano_", clean_name)
  render_commentary(volcano_id, "volcano")

  cat("\n\n")
}
```

## Top Differential Proteins {.tabset}

```{r top_de_tables, results='asis'}
for (contrast_name in names(results$differential$results)) {
  cat(paste0("\n### ", contrast_name, "\n\n"))

  tt <- results$differential$results[[contrast_name]]$table
  top_de <- head(tt[tt$significant, ], 20)

  if (nrow(top_de) > 0) {
    # Select columns to display
    display_cols <- c("feature_id", "log2FC", "P.Value", "adj.P.Val", "direction")
    if ("gene_symbol" %in% colnames(top_de)) {
      display_cols <- c("gene_symbol", display_cols)
    }
    display_cols <- intersect(display_cols, colnames(top_de))

    top_de_display <- top_de[, display_cols]
    top_de_display$log2FC <- round(top_de_display$log2FC, 3)
    top_de_display$P.Value <- format(top_de_display$P.Value, scientific = TRUE, digits = 3)
    top_de_display$adj.P.Val <- format(top_de_display$adj.P.Val, scientific = TRUE, digits = 3)

    if (requireNamespace("DT", quietly = TRUE)) {
      print(DT::datatable(top_de_display, options = list(pageLength = 10, scrollX = TRUE)))
    } else {
      print(kable(top_de_display))
    }
  } else {
    cat("No significant proteins found for this contrast.\n")
  }
  cat("\n\n")
}
```

# Pathway Analysis

```{r pathway_check, results='asis'}
if (is.null(results$pathway)) {
  cat("Pathway analysis was not performed. This may be due to:\n\n")
  cat("- Insufficient gene symbol mappings\n")
  cat("- No custom GMT file provided\n")
  cat("- Organism not supported by annotation databases\n\n")
  cat("To enable pathway analysis, provide a `gene_set_gmt` file in the config or a `mapping_file` with gene symbols.\n")
} else {
  cat("Pathway enrichment analysis was performed using ORA and/or GSEA methods.\n")
}
```

```{r pathway_results, results='asis', eval=!is.null(results$pathway)}
for (contrast_name in names(results$pathway$results)) {
  cat(paste0("\n## ", contrast_name, " {.tabset}\n\n"))

  pathway_data <- results$pathway$results[[contrast_name]]

  # ORA results
  if (!is.null(pathway_data$ora) && nrow(pathway_data$ora) > 0) {
    cat("\n### ORA Results\n\n")

    ora_sig <- pathway_data$ora[pathway_data$ora$p.adjust < 0.1, ]
    ora_top <- head(ora_sig, 15)

    if (nrow(ora_top) > 0) {
      # Dotplot
      ora_top$Description <- if ("Description" %in% colnames(ora_top)) ora_top$Description else ora_top$pathway
      ora_top$short_name <- substr(ora_top$Description, 1, 40)

      if ("Count" %in% colnames(ora_top)) {
        size_var <- "Count"
      } else if ("n_overlap" %in% colnames(ora_top)) {
        size_var <- "n_overlap"
      } else {
        ora_top$size_var <- 5
        size_var <- "size_var"
      }

      p <- ggplot(ora_top, aes(x = -log10(p.adjust), y = reorder(short_name, -log10(p.adjust)))) +
        geom_point(aes_string(size = size_var), color = "#0072B2") +
        labs(title = paste("ORA Enrichment:", contrast_name),
             x = "-Log10(Adjusted P-value)",
             y = "Pathway") +
        theme_minimal() +
        theme(axis.text.y = element_text(size = 8))

      print(p)

      # Table
      display_cols <- intersect(c("Description", "pathway", "Count", "n_overlap", "p.adjust"), colnames(ora_top))
      print(kable(ora_top[, display_cols], caption = "Top ORA Enriched Pathways"))
    }
    cat("\n\n")
  }

  # GSEA results
  if (!is.null(pathway_data$gsea) && nrow(pathway_data$gsea) > 0) {
    cat("\n### GSEA Results\n\n")

    gsea_sig <- pathway_data$gsea[pathway_data$gsea$padj < 0.1, ]
    gsea_top <- head(gsea_sig[order(abs(gsea_sig$NES), decreasing = TRUE), ], 15)

    if (nrow(gsea_top) > 0) {
      gsea_top$short_name <- substr(gsea_top$pathway, 1, 40)
      gsea_top$direction <- ifelse(gsea_top$NES > 0, "Up", "Down")

      p <- ggplot(gsea_top, aes(x = NES, y = reorder(short_name, NES), fill = direction)) +
        geom_bar(stat = "identity") +
        scale_fill_manual(values = c("Up" = "#D55E00", "Down" = "#0072B2")) +
        labs(title = paste("GSEA Enrichment:", contrast_name),
             x = "Normalized Enrichment Score (NES)",
             y = "Pathway") +
        theme_minimal() +
        theme(axis.text.y = element_text(size = 8))

      print(p)

      # Table
      gsea_table <- gsea_top[, c("pathway", "NES", "pval", "padj", "size")]
      gsea_table$NES <- round(gsea_table$NES, 3)
      print(kable(gsea_table, caption = "Top GSEA Enriched Pathways"))
    }
    cat("\n\n")
  }
}
```

# Methods Summary

## Analysis Parameters

```{r methods_params}
methods_df <- data.frame(
  Step = c(
    "Log2 transformation",
    "Normalization",
    "Imputation",
    "Missingness filter (global)",
    "Missingness filter (group)",
    "Differential analysis",
    "Significance threshold (FDR)",
    "Fold change threshold"
  ),
  Setting = c(
    ifelse(config$processing$log_transform, "Applied", "Not applied"),
    config$processing$normalization_method,
    config$imputation$method,
    paste0(config$filtering$global_min_presence * 100, "%"),
    paste0(config$filtering$group_min_presence * 100, "% in any group"),
    config$differential$method,
    config$differential$adj_pvalue_threshold,
    config$differential$log2fc_threshold
  )
)

kable(methods_df, caption = "Analysis Parameters")
```

## R Session Info

```{r session_info}
sessionInfo()
```

# Commentary Summary

```{r commentary_summary}
if (!is.null(commentary_tbl) && nrow(commentary_tbl) > 0) {
  cat("This report includes automated figure commentary.\n\n")

  summary_tbl <- commentary_tbl[, c("figure_id", "title", "confidence", "backend")]
  colnames(summary_tbl) <- c("Figure ID", "Title", "Confidence", "Backend")

  kable(summary_tbl, caption = "Commentary Summary")
} else {
  cat("Figure commentary was not generated for this analysis.\n")
  cat("To enable commentary, set `commentary: enabled: true` in config.yml\n")
}
```

---

*Report generated on `r Sys.time()` using the Proteomics Analysis Pipeline.*
