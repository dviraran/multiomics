# =============================================================================
# Metabolomics Pipeline Configuration
# =============================================================================
# Supports both untargeted LC-MS/GC-MS and targeted metabolomics workflows

# -----------------------------------------------------------------------------
# Input Files (Required)
# -----------------------------------------------------------------------------
input:
  # Path to feature/metabolite matrix (CSV or TSV)
  # Rows = features/metabolites, Columns = samples, Values = intensities/abundances
  feature_matrix: "data/feature_matrix.csv"

  # Path to sample metadata file
  metadata: "data/metadata.csv"

  # Data type: "untargeted" or "targeted"
  data_type: "untargeted"

  # Organism (used for pathway mapping when available)
  organism: "Homo sapiens"

  # Column in metadata containing sample identifiers
  sample_id_column: "sample_id"

# -----------------------------------------------------------------------------
# Optional Input Files
# -----------------------------------------------------------------------------
optional_inputs:
  # Feature metadata (recommended for untargeted)
  # Should include: feature_id, mz, rt, adduct, charge, preliminary_id
  feature_metadata: null  # e.g., "data/feature_metadata.csv"

  # Annotation table: maps features to metabolite IDs
  # Columns: feature_id, metabolite_name, hmdb_id, kegg_id, pubchem_id, chebi_id, formula, class
  annotation_table: null  # e.g., "data/annotations.csv"

  # Pathway mapping: metabolite to pathway
  # Columns: metabolite_id, pathway_id, pathway_name, source (KEGG/SMPDB/custom)
  pathway_mapping: null  # e.g., "data/pathway_mapping.csv"

  # Internal standards list
  # Columns: feature_id, expected_cv, expected_intensity_range
  internal_standards: null  # e.g., "data/internal_standards.csv"

  # Custom gene/metabolite sets (GMT format)
  gmt_file: null  # e.g., "data/metabolite_sets.gmt"

  # MS2 library file (for annotation summary only)
  ms2_library_file: null

# -----------------------------------------------------------------------------
# Sample Type Configuration
# -----------------------------------------------------------------------------
sample_types:
  # Column in metadata indicating sample type (QC, Blank, Sample)
  sample_type_column: "sample_type"

  # Values indicating different sample types
  sample_value: "Sample"
  qc_value: "QC"
  blank_value: "Blank"

  # If no sample_type column exists, all samples treated as biological samples
  assume_all_samples: true

# -----------------------------------------------------------------------------
# Experimental Design
# -----------------------------------------------------------------------------
design:
  # Main grouping variable for differential analysis
  condition_column: "condition"

  # Design formula for statistical analysis
  design_formula: "~ condition"

  # Contrasts for differential analysis
  contrasts:
    - "treated - control"

  # Reference level for condition
  reference_level: "control"

  # Batch variable (optional)
  batch_column: null  # e.g., "batch"

  # Injection order variable (optional, for drift correction)
  injection_order_column: null  # e.g., "injection_order"

# -----------------------------------------------------------------------------
# Data Processing
# -----------------------------------------------------------------------------
processing:
  # Treat zeros as missing values
  zeros_as_na: true

  # Transformation method: "log2", "log10", "none"
  transform: "log2"

  # Add pseudocount before log transform (to handle zeros)
  pseudocount: 1

  # Normalization method: "PQN", "median", "TIC", "quantile", "vsn", "none"
  normalization_method: "PQN"

  # Scaling method for multivariate analysis: "pareto", "autoscale", "none"
  scaling_method: "pareto"

# -----------------------------------------------------------------------------
# Feature Filtering
# -----------------------------------------------------------------------------
filtering:
  # Minimum proportion of samples a feature must be detected in (globally)
  global_min_presence: 0.2

  # Minimum proportion within at least one condition group
  group_min_presence: 0.5

  # Blank filtering: remove features with blank/sample ratio above threshold
  # Set to null to disable
  blank_ratio_threshold: 0.3

  # QC-based filtering: maximum RSD in QC samples (e.g., 0.3 = 30%)
  # Set to null to disable
  qc_rsd_threshold: 0.3

  # Remove near-zero variance features
  remove_low_variance: true
  variance_percentile: 0.05  # Remove bottom 5% by variance

# -----------------------------------------------------------------------------
# Batch Correction
# -----------------------------------------------------------------------------
batch_correction:
  # Method: "none", "combat", "removeBatchEffect", "qcrlsc"
  # qcrlsc requires QC samples and injection_order
  method: "none"

  # For ComBat: use parametric adjustment
  combat_parametric: true

  # For QCRLSC: LOESS span parameter
  loess_span: 0.75

# -----------------------------------------------------------------------------
# Missing Value Imputation
# -----------------------------------------------------------------------------
imputation:
  # Method: "half_min", "minprob", "QRILC", "knn", "none"
  method: "half_min"

  # For half_min: fraction of minimum value to use
  half_min_fraction: 0.5

  # For MinProb: quantile for sampling
  min_prob_quantile: 0.01

  # For kNN: number of neighbors
  knn_k: 10

# -----------------------------------------------------------------------------
# Quality Control Parameters
# -----------------------------------------------------------------------------
qc:
  # Number of PCA components
  n_pca_components: 10

  # Outlier detection threshold (SD from mean in PCA space)
  outlier_sd_threshold: 3

  # Minimum total signal for sample (percentile threshold)
  min_total_signal_percentile: 0.05

  # Run UMAP in addition to PCA
  run_umap: true

# -----------------------------------------------------------------------------
# Differential Analysis
# -----------------------------------------------------------------------------
differential:
  # Statistical method: "limma", "t_test", "wilcoxon"
  method: "limma"

  # Adjusted p-value threshold
  adj_pvalue_threshold: 0.05

  # Log2 fold change threshold
  log2fc_threshold: 1

  # Minimum samples per group
  min_samples_per_group: 3

# -----------------------------------------------------------------------------
# Multivariate Analysis
# -----------------------------------------------------------------------------
multivariate:
  # Run PLS-DA (exploratory only, includes CV)
  run_plsda: false

  # Number of components for PLS-DA
  plsda_ncomp: 3

  # Cross-validation folds for PLS-DA
  plsda_cv_folds: 5

# -----------------------------------------------------------------------------
# Enrichment Analysis
# -----------------------------------------------------------------------------
enrichment:
  # Run pathway/set enrichment
  run_enrichment: true

  # Methods: "ora" (over-representation), "gsea" (rank-based)
  methods:
    - "ora"

  # P-value threshold for ORA significant metabolites
  ora_pvalue_threshold: 0.05

  # Minimum and maximum set sizes
  min_set_size: 3
  max_set_size: 500

  # Chemical class enrichment (if class annotations available)
  run_class_enrichment: true

# -----------------------------------------------------------------------------
# Output Settings
# -----------------------------------------------------------------------------
output:
  output_dir: "outputs"
  report_format: "html"
  interactive_plots: true
  fig_width: 10
  fig_height: 8
  plot_dpi: 300

# -----------------------------------------------------------------------------
# Duplicate Feature Handling
# -----------------------------------------------------------------------------
duplicates:
  # Strategy: "keep_most_complete", "aggregate_median", "aggregate_mean", "keep_first"
  strategy: "keep_most_complete"
